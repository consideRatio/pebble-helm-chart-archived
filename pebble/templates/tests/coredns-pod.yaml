{{- /*
To avoid needing to wait for a slow startup of Kubernetes cluster's DNS server,
we use the IP addresses instead. The $pebble_svc_host will render to
$(PEBBLE_SERVICE_HOST) which in turn will expand by kubelet to the Kubernetes
service IP.
*/ -}}
{{- $pebble_coredns_service_host := printf "$(%s_COREDNS_SERVICE_HOST)" (include "pebble.fullname" .) | upper | replace "-" "_" -}}
{{- $pebble_service_host := printf "$(%s_SERVICE_HOST)" (include "pebble.fullname" .) | upper | replace "-" "_" -}}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "pebble.fullname" . }}-coredns-test"
  labels:
    {{- include "pebble.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": test-success
spec:
  initContainers:
    - name: dns-cname-lookup
      image: curlimages/curl:7.70.0
      command: ["sh", "-c"]
      args:
        - nslookup -type=CNAME demo.test {{ $pebble_coredns_service_host }} | grep pebble.{{ .Release.Namespace }}.svc.cluster.local
    - name: dns-a-lookup
      image: curlimages/curl:7.70.0
      command: ["sh", "-c"]
      args:
        - nslookup -type=A demo.test {{ $pebble_coredns_service_host }} | grep {{ $pebble_service_host }}
  containers:
    - name: completed
      image: curlimages/curl:7.70.0
      command: ["echo"]
      args: ["Success!"]
  restartPolicy: Never
